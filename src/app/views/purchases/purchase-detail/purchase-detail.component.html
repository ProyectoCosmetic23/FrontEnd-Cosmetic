<div class="row" *ngIf="!loading">
  <div class="breadcrumb">
    <h1 *ngIf="viewMode === 'new'">Registrar Compra</h1>
    <h1 *ngIf="viewMode === 'print'">Detalle de  Compra</h1>
    <h1 *ngIf="viewMode === 'print'"></h1>
    <ul>
      <li><a [routerLink]="['/purchases']">Compras</a></li>
      <li *ngIf="viewMode === 'new'">Registrar Compra</li>
      <li *ngIf="viewMode === 'print'"> Detalle de Compra</li>
    </ul>
  </div>
  </div>
  <div class="row">
    <div class="col-md-12">
      <div class="card mb-4">
        <div class="card-body">
          <div class="card-title mb-3">Formulario de Compra</div>

      

              <div *ngIf="viewMode === 'new' || viewMode === 'print' ">

                  <form [formGroup]="purchaseForm" >

                      <div class="row">

                        <div class="col-md-4">
                          <div class="form-group" >
                            <label for="invoice_number">Numero Factura<span class="required" *ngIf="viewMode === 'new'">*</span></label>
                            <input type="text"   class="form-control" id="invoice_number" name="invoice_number" 
                            formControlName="invoice_number" style="width: 100%;" (keyup)="validatePurchaseExist()"/>
                            <div *ngIf="purchaseForm.get('invoice_number').touched && purchaseForm.get('invoice_number').hasError('required')"class="error-message">
                              El campo  es obligatorio.
                          </div>
                          <div *ngIf="viewMode === 'new'">
                            <div *ngIf="purchaseExists" class="error-message">El número de factura ya existe.</div>
                          </div>
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="form-group" [ngClass]="{'disabled-field': viewMode === 'print'}">
                            <label for="id_provider">Proveedor<span class="required" *ngIf="viewMode === 'new'">*</span></label>
                            <select class="form-control" id="id_provider" name="id_provider" formControlName="id_provider" (change)="handleProviderSelection($event, i)" [disabled]="viewMode === 'print'">
                              <option *ngFor="let provider of listProviders" [value]="provider.id_provider">{{ provider.name_provider }}</option>
                            
                         
                        </select>
                            <div *ngIf="purchaseForm.get('id_provider').touched && purchaseForm.get('id_provider').hasError('required')" class="error-message">
                              El campo es obligatorio.
                        </div>
                          
                         
                        </div>
                        </div>
                       <div class="col-md-3">
                          <div class="form-grouP">
                            <label for="picker1">Fecha Compra<span class="required" *ngIf="viewMode === 'new'">*</span></label>
                              <input formControlName="purchase_date"
                              [minDate]="minDate" [maxDate]="maxDate"  id="picker1" name="purchase_date" class="form-control text-right" name="dp" ngbDatepicker #orderDatePicker="ngbDatepicker" >
                          </div>
                          <div *ngIf="purchaseForm.get('purchase_date').touched && purchaseForm.get('purchase_date').hasError('required')"class="error-message">
                            El campo  es obligatorio.
                        </div>
                        </div>
                        <div class="col-md-1 align-self-end" *ngIf="viewMode === 'new'">
                          <div class="form-group">
                            <label for=""></label>
                            <button class="btn btn-secondary" (click)="orderDatePicker.toggle()" type="button" >
                              <i class="icon-regular i-Calendar-4"></i>
                            </button>
                          </div>
                        </div>
                        <div class="col-md-4" *ngIf="viewMode === 'print'">
                        <div class="form-grouP">
                          <label for="picker1">Fecha Registro</label>
                            <input formControlName="record_date_purchase"
                            [minDate]="minDate" [maxDate]="maxDate"  id="picker1" name="record_date_purchase" class="form-control text-right" name="dp" ngbDatepicker #orderDatePicker="ngbDatepicker" >
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-md-12 form-group mb-12">
                          <label for="observation_purchase">Observación</label>
                          <textarea
                            class="form-control"
                            id="observation_purchase"
                            formControlName="observation_purchase"
                            *ngIf="viewMode === 'print' || viewMode === 'new'"
                            [ngStyle]="{ 'max-width.px': 1000 }"
                            [disabled]="viewMode === 'print'"></textarea>
                          <div *ngIf="purchaseForm.get('observation_purchase').touched && purchaseForm.get('observation_purchase').hasError('maxlength')" class="error-message">
                            El campo supera los 100 caracteres.
                          </div>
                        </div>
                        
                   
                        
                      </div>
                      

                
                          </div>
                   

                      <div class="mt-3 mb-4 border-top"></div>
                      <div *ngIf="viewMode === 'new'">
                      <form class="row"  [formGroup]="purchaseDetailform" >
                          <div class="col-md-3">
                            <div class="form-group">
                              <label for="id_category">Categoría<span class="required" *ngIf="viewMode === 'new'">*</span></label>
                              <select class="form-control" id="id_category" name="id_category" formControlName="id_category"
                              (change)="handleCategorySelection($event, i)"> 
                              <option *ngFor="let category of listCategories" [value]="category.id_category">{{ category.name_category }}</option>
                              </select>
                              <div *ngIf="purchaseDetailform.get('id_category').touched && purchaseDetailform.get('id_category').hasError('required')"class="error-message">
                                El campo  es obligatorio.
                            </div>
                         
                            </div>
                          </div>

                            <div class="col-md-3">
                              <div class="form-group">
                                <label for="id_product">Producto<span class="required" *ngIf="viewMode === 'new'">*</span></label>
                                <select class="form-control" id="id_product" name="id_product" formControlName="id_product"
                                (change)="handleProductSelection($event, i)">
                                <option *ngFor="let product of products" [value]="product.id_product">{{
                                  product.name_product }}</option>
                              </select>
                              <div *ngIf="purchaseDetailform.get('id_product').touched && purchaseDetailform.get('id_product').hasError('required')"class="error-message">
                                El campo  es obligatorio.
                            </div>
                        
                              </div>
                            </div>
                         
                            <div class="col-md-3 align-self-end">
                              <div class="form-group">
                                <label for="id_product"></label>
                                <button class="btn btn-secondary" (click)="openCreateProductModal(createProductModal)"><i class="i-Add"></i></button>

                              </div>
                            </div>
                         
                         
                          <div class="row">
                    
                    
                            <div class="col-md-3">
                              <div class="form-group">
                                <label for="cost_price">Precio Compra<span class="required" *ngIf="viewMode === 'new'">*</span></label>
                                <input type="number" min="0"  class="form-control" id="cost_price" name="cost_price" formControlName="cost_price"
                                  style="width: 100%;" />
                              </div>
                              <div *ngIf="purchaseDetailform.get('cost_price').touched && purchaseDetailform.get('cost_price').hasError('required')"class="error-message">
                                El campo  es obligatorio.
                            </div>
                            </div>
                    
                    
                            <div class="col-md-3">
                              <div class="form-group">
                                <label for="selling_price">Precio Venta<span class="required" *ngIf="viewMode === 'new'">*</span></label>
                                <input type="number" min="0" class="form-control" id="selling_price" name="selling_price" formControlName="selling_price"
                                  style="width: 100%;" />   
                              </div>
                              <div *ngIf="purchaseDetailform.get('selling_price').touched && purchaseDetailform.get('selling_price').hasError('required')"class="error-message">
                                El campo  es obligatorio.
                            </div>
                            <div *ngIf="purchaseDetailform.get('selling_price').touched && purchaseDetailform.get('selling_price').hasError('invalidSellingPrice')"class="error-message">
                              El precio de venta no puede ser menor al precio de compra
                          </div>
                            </div>
                    
                    
                            <div class="col-md-3">
                              <div class="form-group">
                                <label for="vat">Iva<span class="required" *ngIf="viewMode === 'new'">*</span></label>
                                <input type="number" min="0" class="form-control" id="vat" name="vat" formControlName="vat"
                                  style="width: 100%;" />
                                  <div *ngIf="purchaseDetailform.get('vat').touched && purchaseDetailform.get('vat').hasError('invalidVat')"class="error-message">
                                   El iva no puede superar el precio de compra
                                </div>
                              </div>
                            </div>
                    
                    
                            <div class="col-md-3">
                              <div class="form-group">
                                <label for="product_quantity">Cantidad<span class="required" *ngIf="viewMode === 'new'">*</span></label>
                                <input type="number" min="1" class="form-control" id="product_quantity" name="product_quantity"  formControlName="product_quantity"
                                  style="width: 100%;" />
                                  <div *ngIf="purchaseDetailform.get('product_quantity').touched && purchaseDetailform.get('product_quantity').hasError('required')"class="error-message">
                                    El campo  es obligatorio.
                                </div>
                              </div>
                            </div>
                    
                          </div>
                      </form>
                          
                    
                          <div class="button_container">
                            <button class="btn btn-primary" (click)="addPurchaseDetail()" type="button">Agregar Producto</button>
                          </div>
                          <br>

                          <div class="col-md-12">

                          </div>   
                        </div>
                  <div class="col-md-12 table-responsive">
                    <table class="table table-hover mb-4">
                      <thead class="bg-gray-300">
                        <tr>
                          <th scope="col">#</th>
                          <th scope="col" >Categoría</th>
                          <th scope="col" >Producto</th>
                          <th scope="col" >Precio Compra</th>
                          <th scope="col" >Precio Venta</th>
                          <th scope="col" >Iva</th>
                          <th scope="col" >Cantidad</th>
                          <th scope="col" >Sub Total</th>
                          <th scope="col" *ngIf="viewMode === 'new'">Acciones</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let item of purchaseDetailArray; let i = index">
                          <td><i>{{ i + 1 }}</i></td>
                          <td>{{ item.name_category }}</td>                       
                          <td>{{  item.name_product }}</td>
                          <td>{{ item.cost_price | currency:'':'symbol':'1.0-0' }}</td>
                          <td>{{ item.selling_price | currency:'':'symbol':'1.0-0' }}</td>
                          <td>{{ item.vat | currency:'':'symbol':'1.0-0' }}</td>
                          <td>{{ item.product_quantity }}</td>
                          <td>{{( calculateSubtotal(item.cost_price, item.vat, item.product_quantity) | currency:'':'symbol':'1.0-0' ) }}


                          </td>
                          <td>
                            <button class="btn btn-danger" (click)="removePurchaseDetail(i)" *ngIf="viewMode === 'new'">
                              <i class="i-Remove-Cart"></i>
                            </button>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                    <div class="table-footer">
                      <div class="col-md-8"></div>
                      <div class="col-md-8" *ngIf="viewMode === 'new' || viewMode === 'print'">
                        <div class="total" >Total: {{   calculateTotal()  | currency:'':'symbol':'1.0-0' }} </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-12" style="margin-top: 20px;">
                    
                    <div class="form-group text-right" style="text-align: right;" *ngIf="viewMode === 'new'">
                      <button type="button" class="btn btn-danger ml-2" (click)="cancel()">Cancelar</button>
                      <button class="btn btn-primary m-1 custom-button" [disabled]="loading" (click)="submitPurchase()">Registrar Compra </button>

                    </div>
                          
              </div>
            </form>
            <ng-template #createProductModal let-modal>
              <div class="modal-header">
                  <h4 class="modal-title" id="modal-title">Crear Producto</h4>

              </div>
              <div class="modal-body">
                  <form [formGroup]="productForm">
                    <div class="row">
                      <div class="col-md-6 form-group mb-3">
                        <label for="id_category">Categoria<span class="text-danger">*</span></label>
                        <select class="form-control" id="id_category" name="id_category" formControlName="id_category"
                        (change)="handleCategorySelection($event, i)"> 
                        <option *ngFor="let category of listCategories" [value]="category.id_category">{{ category.name_category }}</option>
                        </select>
                        <div *ngIf="productForm.get('id_category').touched && productForm.get('id_category').hasError('required')"class="error-message">
                          El campo  es obligatorio.
                      </div>
                    </div>
                    
                    <div class="col-md-6 form-group mb-3">
                        <label for="name_product">Nombre de producto<span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="name_product" name="name_product"  formControlName="name_product" required (keyup)="validateProductExist()">
                        <div *ngIf="productForm.get('name_product').touched && productForm.get('name_product').hasError('required')"class="error-message">
                          El campo  es obligatorio.
                      </div>
                      <div *ngIf="  productForm.get('name_product').hasError('maxLength')"class="error-message">
                        El campo  solo puede contener 80 carácteres
                    </div>
                    <div *ngIf="productForm.get('name_product').hasError('pattern')"class="error-message">
                      El campo  solo acepta letras y numeros
                  </div>
                  <div *ngIf="viewMode === 'new'">
                    <div *ngIf="productExists" class="error-message">El número de factura ya existe.</div>
                  </div>
                    </div>
                    </div>
                <div class="row">
                  <div class="col-md-6 form-group mb-3">
                    <label for="min_stock">Stock Minímo<span class="text-danger">*</span></label>
                    <input type="number" min="0" class="form-control" id="min_stock"  name="min_stock" formControlName="min_stock">
                    <div *ngIf="productForm.get('selling_price').touched && productForm.get('selling_price').hasError('required')"class="error-message">
                      El campo  es obligatorio.
                  </div>
                </div>
                <div class="col-md-6 form-group mb-3">
                  <label for="max_stock">Stock Maxímo<span class="text-danger">*</span></label>
                  <input type="number" min="0" class="form-control" id="max_stock"  name="max_stock" formControlName="max_stock">
                  <div *ngIf="productForm.get('max_stock').touched && productForm.get('max_stock').hasError('required')"class="error-message" min=0>
                    El campo  es obligatorio.
                </div>
                <div *ngIf="productForm.get('max_stock').touched && productForm.get('max_stock').hasError('invalidStock')"class="error-message">
                  El stock maxímo no puedo ser menor al stock minímo
              </div>
              </div>
                </div>
                  <div class="col-md-6 form-group mb-3">
                    <label for="observation">Observación</label>
                    <textarea type="text" class="form-control" id="observation" name="observation" formControlName="observation" ></textarea>
                    <div *ngIf="productForm.get('observation').touched && productForm.get('observation').hasError('maxLength')"class="error-message">
                      El campo  solo puede contener 80 carácteres
                  </div>
                </div>
                
                  
                  </form>
          
              </div>
          
              <div class="modal-footer">
                  <button type="button" class="btn btn-outline-secondary btn"
                      (click)="modal.dismiss('cancel')">Cancelar</button>
                  <button type="submit" ngbAutofocus class="btn btn-wide btn-danger btn" [disabled]="!this.productForm.valid || this.productExists"
                      (click)="modal.close('Ok')">Crear Producto</button>
              </div> 
          </ng-template>

          </div>

      </div>
  </div>
</div>

