<div class="breadcrumb">
  <h1>Pedidos</h1>
  <ul>
    <li>Ventas</li>
    <li>Pedidos</li>
  </ul>
</div>

<div class="separator-breadcrumb border-top"></div>

<div class="row mb-3">
  <div class="col-md-12 mb-3 d-flex justify-content-between align-items-center">
    <div class="col-md-4">
      <div class="form-group">
        <button class="btn btn-primary" [routerLink]="['/orders/new']">
          Crear nuevo Pedido
        </button>
      </div>
    </div>
    <div class="col-md-4">
      <div class="form-group">
        <input
          id="role"
          placeholder="Buscar Pedido"
          [formControl]="searchControl"
          class="form-control"
          type="role"
        />
      </div>
    </div>
  </div>
  <div class="col-md-12">
    <!-- <tabset>
      <tab
        id="todos"
        heading="Todos los Pedidos"
        (selectTab)="onTabSelect('Pedidos Por Entregar')"
        class="custom-tab"
      >
      </tab>
      <tab
        id="porEntregar"
        heading="Pedidos por Entregar"
        (selectTab)="onTabSelect('Pedidos Por Entregar')"
        class="custom-tab"
      >
      </tab>
      <tab
        id="entregados"
        heading="Pedidos Entregados"
        (selectTab)="onTabSelect('Pedidos Entregados')"
        class="custom-tab"
      >
      </tab>
      <tab
        id="porPagar"
        heading="Pedidos por Pagar"
        (selectTab)="onTabSelect('Pedidos Por Pagar')"
        class="custom-tab"
      >
      </tab>
      <tab
        id="pagados"
        heading="Pedidos Pagados"
        (selectTab)="onTabSelect('Pedidos Pagados')"
        class="custom-tab"
      >
      </tab>
      <tab
        id="anulados"
        heading="Pedidos Anulados"
        (selectTab)="onTabSelect('Pedidos Anulados')"
        class="custom-tab"
      >
      </tab>
    </tabset>     -->

    <div class="card o-hidden">
      <div *ngIf="showLoadingScreen" class="loading-screen">
        <div class="loading-content">
          <div class="spinner spinner-primary me-3"></div>
        </div>
      </div>

      <div *ngIf="showLoadingScreen == false">
        <ngx-datatable
          class="material fullscreen"
          style="height: 460px"
          [columnMode]="'force'"
          [headerHeight]="50"
          [footerHeight]="50"
          [rowHeight]="60"
          [scrollbarV]="true"
          [rows]="listOrders"
          [externalPaging]="true"
          [count]="listOrders.length"
          [limit]="itemsPerPage"
          [offset]="(currentPage - 1) * itemsPerPage"
          (page)="onPageChange($event)"
        >
          <ngx-datatable-column
            name="order_number"
            [resizeable]="false"
            [canAutoResize]="true"
            [maxWidth]="60"
          >
            <ng-template ngx-datatable-header-template>
              <p style="font-size: 10px; text-align: center">NÂ°</p>
            </ng-template>
            <ng-template
              ngx-datatable-cell-template
              let-value="value"
              let-row="row"
            >
              <ng-container *ngIf="row && row.id_order">
                <p
                  style="font-size: 10px; text-align: center; margin-top: 12px"
                >
                  {{ row.order_number }}
                </p>
              </ng-container>
            </ng-template>
          </ngx-datatable-column>
          <ngx-datatable-column
            name="client"
            [resizeable]="false"
            [canAutoResize]="true"
          >
            <ng-template ngx-datatable-header-template>
              <p style="font-size: 10px; text-align: center">Cliente</p>
            </ng-template>
            <ng-template
              ngx-datatable-cell-template
              let-value="value"
              let-row="row"
            >
              <ng-container *ngIf="row && row.id_order">
                <p
                  style="font-size: 10px; text-align: center; margin-top: 12px"
                >
                  {{ row.name_client }}
                </p>
              </ng-container>
            </ng-template>
          </ngx-datatable-column>
          <ngx-datatable-column
            name="order_date"
            [resizeable]="false"
            [canAutoResize]="true"
            [maxWidth]="100"
          >
            <ng-template ngx-datatable-header-template>
              <p style="font-size: 12px; text-align: center">Fecha</p>
            </ng-template>
            <ng-template
              ngx-datatable-cell-template
              let-value="value"
              let-row="row"
            >
              <ng-container *ngIf="row && row.id_order">
                <p
                  style="font-size: 10px; text-align: center; margin-top: 12px"
                >
                  {{ row.order_date }}
                </p>
              </ng-container>
            </ng-template>
          </ngx-datatable-column>
          <ngx-datatable-column
            name="order_state"
            [resizeable]="false"
            [canAutoResize]="true"
          >
            <ng-template ngx-datatable-header-template>
              <p style="font-size: 12px; text-align: center">
                Estado de Pedido
              </p>
            </ng-template>
            <ng-template
              ngx-datatable-cell-template
              let-value="value"
              let-row="row"
            >
              <ng-container *ngIf="row && row.id_order">
                <p
                  style="font-size: 10px; text-align: center; margin-top: 12px"
                >
                  {{ row.order_state }}
                </p>
              </ng-container>
            </ng-template>
          </ngx-datatable-column>
          <ngx-datatable-column
            name="delivery_state"
            [resizeable]="false"
            [canAutoResize]="true"
          >
            <ng-template ngx-datatable-header-template>
              <p style="font-size: 102x; text-align: center">
                Estado de Entrega
              </p>
            </ng-template>
            <ng-template
              ngx-datatable-cell-template
              let-value="value"
              let-row="row"
            >
              <ng-container *ngIf="row && row.id_order">
                <p
                  style="font-size: 10px; text-align: center; margin-top: 12px"
                >
                  {{ row.delivery_state }}
                </p>
              </ng-container>
            </ng-template>
          </ngx-datatable-column>
          <ngx-datatable-column
            name="payment_state"
            [resizeable]="false"
            [canAutoResize]="true"
          >
            <ng-template ngx-datatable-header-template>
              <p style="font-size: 12px; text-align: center">Estado de Pago</p>
            </ng-template>
            <ng-template
              ngx-datatable-cell-template
              let-value="value"
              let-row="row"
            >
              <ng-container *ngIf="row && row.id_order">
                <p
                  style="font-size: 10px; text-align: center; margin-top: 12px"
                >
                  {{ row.payment_state }}
                </p>
              </ng-container>
            </ng-template>
          </ngx-datatable-column>
          <ngx-datatable-column
            name="total_order"
            [resizeable]="false"
            [canAutoResize]="true"
            [maxWidth]="100"
          >
            <ng-template ngx-datatable-header-template>
              <p style="font-size: 12px; text-align: center">Total</p>
            </ng-template>
            <ng-template
              ngx-datatable-cell-template
              let-value="value"
              let-row="row"
            >
              <ng-container *ngIf="row && row.id_order">
                <p
                  style="font-size: 10px; text-align: center; margin-top: 12px"
                >
                  {{ row.total_order | currency : "" : "symbol" : "1.2-2" }}
                </p>
              </ng-container>
            </ng-template>
          </ngx-datatable-column>
          <ngx-datatable-column
            name="actions"
            [resizeable]="false"
            [canAutoResize]="true"
          >
            <ng-template ngx-datatable-header-template>
              <p style="font-size: 12px">Acciones</p>
            </ng-template>
            <ng-template
              ngx-datatable-cell-template
              let-value="value"
              let-row="row"
            >
              <ng-container *ngIf="row && row.id_order">
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    margin-top: 5px;
                  "
                >
                  <!-- Ver detalle -->
                  <button
                    class="btn btn-dark btn-sm"
                    data-toggle="tooltip"
                    data-placement="top"
                    title="Ver detalle"
                    [routerLink]="['/orders/detail', row.id_order]"
                  >
                    <i class="i-Eye" style="font-size: 15px"></i>
                  </button>

                  <!-- Realizar pago -->
                  <button
                    class="btn btn-success btn-sm"
                    data-toggle="tooltip"
                    data-placement="top"
                    title="Realizar pago"
                    (click)="openPayments(row.id_order)"
                    [disabled]="row.payment_state == 'Pagado' || row.order_state == 'Anulado'"
                  >
                    <i class="i-Financial" style="font-size: 15px"></i>
                  </button>

                  <!-- Enviar pedido -->
                  <button
                    class="btn btn-sm"
                    [ngClass]="{
                      'btn-warning': row.delivery_state === 'En proceso',
                      'btn-primary':
                        row.delivery_state === 'Por entregar' ||
                        row.delivery_state === 'Entregado'
                    }"
                    *ngIf="
                      ['En proceso', 'Por entregar', 'Entregado'].includes(
                        row.delivery_state
                      )
                    "
                    data-toggle="tooltip"
                    data-placement="top"
                    title="Enviar pedido"
                    (click)="
                      openModal(row.id_order, 'Enviar', row.delivery_state)
                    "
                    [disabled]="row.delivery_state == 'Entregado' || row.order_state == 'Anulado'"
                  >
                    <i class="i-Jeep" style="font-size: 15px"></i>
                  </button>

                  <!-- Anular pedido -->
                  <button
                    class="btn btn-danger btn-sm"
                    data-toggle="tooltip"
                    data-placement="top"
                    title="Anular pedido"
                    (click)="openModal(row.id_order, 'Anular')"
                    [disabled]="row.order_state == 'Anulado'"
                  >
                    <i class="i-Close" style="font-size: 15px"></i>
                  </button>
                </div>
              </ng-container>
            </ng-template>
          </ngx-datatable-column>
        </ngx-datatable>
      </div>
    </div>
  </div>
</div>

<ng-template #deleteConfirmModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title" id="modal-title">Cambiar Estado del Pedido</h4>
    <button
      type="button"
      class="close"
      aria-label="Close button"
      aria-describedby="modal-title"
      (click)="modal.dismiss('Cross click')"
    >
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <p>
      <strong>{{ modal_message }}</strong>
    </p>
  </div>
  <div class="modal-footer">
    <button
      type="button"
      class="btn btn-outline-secondary btn-rounded"
      (click)="modal.dismiss('cancel')"
    >
      Cancelar
    </button>
    <button
      type="button"
      ngbAutofocus
      class="btn btn-wide btn-danger btn-rounded"
      (click)="modal.close('Ok')"
    >
      Aceptar
    </button>
  </div>
</ng-template>

<ng-template #paymentModal let-modal>
  <ul class="nav nav-tabs">
    <li
      class="nav-item"
      (click)="activeTab = 'formulario'"
      style="cursor: pointer"
    >
      <a class="nav-link" [class.active]="activeTab === 'formulario'"
        >Registrar pago</a
      >
    </li>
    <li class="nav-item" (click)="activeTab = 'abonos'" style="cursor: pointer">
      <a class="nav-link" [class.active]="activeTab === 'abonos'"
        >Pagos registrados</a
      >
    </li>
  </ul>

  <div class="tab-content">
    <div class="tab-pane" [class.active]="activeTab === 'formulario'">
      <form [formGroup]="formBasic" (ngSubmit)="submit()">
        <div class="row">
          <div class="col-md-6 form-group mb-3">
            <label for="id_client">Nombre cliente</label>
            <input
              class="form-control"
              id="id_client"
              [readonly]="true"
              (change)="handleClientSelection($event)"
              formControlName="id_client"
            />
          </div>

          <div class="col-md-6 form-group mb-3">
            <label for="payment_date">Fecha de pago</label>
            <input
              type="text"
              class="form-control"
              id="payment_date"
              [placeholder]="'Fecha de pago'"
              [readonly]="true"
              [value]="
                formBasic.get('payment_date').value | date : 'yyyy-MM-dd'
              "
            />
          </div>
          <!-- <div class="col-md-6 form-group mb-3">
            <label for="id_order"># Orden</label>
            <input
              class="form-control"
              id="id_order"
              [readonly]="true"
              formControlName="id_order"
              (change)="handleOrderSelection($event)"
            />
          </div>
            <input class="form-control" id="id_order" [readonly]="true" formControlName="id_order"
              (change)="handleOrderSelection($event)" />
          </div> -->
          <div class="col-md-6 form-group mb-3">
            <label for="total_payment"
              >Monto pago<span class="text-danger">*</span></label
            >
            <input
              type="number"
              class="form-control"
              id="total_payment"
              [placeholder]="'Monto pago'"
              [readonly]="viewMode === 'print'"
              (change)="updateTotalRemaining()"
              formControlName="total_payment"
            />
          </div>

          <div class="col-md-6 form-group mb-3">
            <label for="total_order">Total pedido</label>
            <input
              class="form-control"
              id="total_order"
              [readonly]="true"
              formControlName="total_order"
            />
          </div>

          <div class="col-md-6 form-group mb-3">
            <label for="total_remaining">Total restante</label>
            <input
              type="number"
              class="form-control"
              id="total_remaining"
              [placeholder]="'Total restante'"
              [readonly]="true"
              [ngClass]="{ 'placeholder-black': viewMode === 'print' }"
              formControlName="total_remaining"
            />
          </div>
          <div class="col-md-12">
            <div class="d-flex justify-content-end">
              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-outline-secondary btn-rounded"
                  (click)="modal.close('cancel')"
                >
                  Cancelar
                </button>
                <button
                  type="button"
                  ngbAutofocus
                  class="btn btn-wide btn-primary btn-rounded"
                  (click)="asignarPago()"
                >
                  Pagar
                </button>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
    <div class="tab-pane" [class.active]="activeTab === 'abonos'">
      <div class="tab-pane" [class.active]="activeTab === 'abonos'">
        <h1 class="text-center">
          Pagos del pedido {{ currentOrder?.order_number }}
        </h1>
        <div *ngFor="let payment of paymentsForOrder">
          <p style="display: inline-block; margin-right: 50px">
            <b>Fecha Pago: </b>{{ payment.payment_date | date : "yyyy-MM-dd" }}
            <b>Monto Pago:</b>
            {{ payment.total_payment | currency : "" : "symbol" : "1.2-2" }}
            <b>Monto Restante:</b>
            {{ payment.total_remaining | currency : "" : "symbol" : "1.2-2" }}
          </p>
        </div>
      </div>
    </div>
  </div>
</ng-template>
